---
namespace: sonarqube-postgresql

database:
  defines: runnable
  inherits: postgresql/db
  metadata:
    private: true
  services:
    postgres:
      container: postgres
      port: 5432
      protocol: tcp
  variables:
    postgres_password:
      value: <- `${database-password}`
      type: string
    db_username:
      value: <- `${database-user}`
      type: string
    db_name:
      value: <- `${database-name}`
      type: string
  checks:
    readiness:
      code: exec("postgres", "pg_isready") "accepting connections" contains?
      period: 15
      initialDelay: 15

nginx:
  defines: runnable
  metadata:
    private: true
  services:
    nginx:
      container: nginx-reverse-proxy
      port: <- `${listen-port}` to-i
      protocol: tcp
      host-port: <- `${listen-port}` to-i
  connections:
    sonarqube:
      runnable: sonarqube-postgresql/sonarqube
      service: sonarqube
  files:
    server-def:
      contents: |
        server {
          listen 0.0.0.0:{{ v "listen-port" }};
          location / {
            proxy_set_header X-Real-IP  $remote_addr;
            proxy_set_header X-Forwarded-For $remote_addr;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header Host $host;
            proxy_pass http://{{ v "proxy-target-host" }}:9000;
          }
        }
      mode: 511
      path: /opt/bitnami/nginx/conf/server_blocks/reverse_proxy.conf
      container: nginx-reverse-proxy
  containers:
    nginx-reverse-proxy:
      image-tag: <- `${nginx-image}`
      image: docker.io/bitnami/nginx
      ports:
        - <- `0.0.0.0:${listen-port}:${listen-port}/tcp`
      cap-add:
        - CAP_NET_BIND_SERVICE
  depends:
    wait-for:
      runnables:
        - sonarqube-postgresql/sonarqube
      timeout: 30
  variables:
    proxy-target-host:
      value: <- connection-hostname("sonarqube")
      type: string
    listen-port:
      value: <- $nginx-listen-port
      type: string
    server-name:
      value: <- $sonarqube-server-name
      type: string
    nginx-image:
      value: <- $nginx-image-tag
      type: string

sonarqube:
  defines: runnable
  metadata:
    name: Sonarqube
    shortname: Sonarqube
    description: |
      SonarQube is a powerful and comprehensive platform for managing code quality. It provides a suite of tools and features for performing static code analysis, continuous code inspection, and ensuring code security, maintainability, and reliability. With SonarQube, developers can easily detect and fix code issues such as bugs, code smells, and security vulnerabilities, improving the overall quality of their codebase.

      SonarQube provides a range of metrics and indicators for measuring code quality, including code coverage, technical debt, and maintainability. It also offers a Quality Gate feature which enables developers to define quality criteria that must be met before new code can be integrated into the main codebase, ensuring that only high-quality code is released into production.

      SonarQube seamlessly integrates with popular development tools such as Jenkins, GitLab, and GitHub, making it easy to incorporate code quality checks into existing workflows. It also provides automated testing and vulnerability detection features, further enhancing the reliability and security of the code.

      Overall, SonarQube is an essential tool for developers looking to improve the quality of their code, adopt best practices, and ensure that their code meets the highest standards of reliability and security.
    tags: SonarQube, Code Quality, Static Code Analysis, Continuous Code Inspection, Code Security, Code Maintainability, Technical Debt, Code Coverage, Quality Gate, DevOps, Code Review, Software Development, Automated Testing, Vulnerability Detection, Best Practices
    website: https://www.sonarqube.org/
    source: https://github.com/SonarSource/sonarqube
    publisher: monk.io
    icon: https://www.sonarqube.org/logos/index/sonarqube-logo.png
    version: 1.0
    private: true
  services:
    sonarqube:
      container: sonarqube
      port: 9000
      protocol: tcp
      host-port: 9000
  connections:
    postgres:
      runnable: sonarqube-postgresql/database
      service: postgres
  containers:
    sonarqube:
      image: sonarqube
      image-tag: <- `${SONARQUBE_IMAGE}`
      paths:
        - <- `${monk-volume-path}/sonarqube/data:/opt/sonarqube/data`
        - <- `${monk-volume-path}/sonarqube/extensions:/opt/sonarqube/extensions`
        - <- `${monk-volume-path}/sonarqube/logs:/opt/sonarqube/logs`
  depends:
    wait-for:
      runnables:
        - sonarqube-postgresql/database
      timeout: 30
  variables:
    SONAR_JDBC_URL:
      env: SONAR_JDBC_URL
      type: string
      value: <- `jdbc:postgresql://${db-host}:5432/${db-name}`
    db-user:
      env: SONAR_JDBC_USERNAME
      type: string
      value: <- `${database-user}`
    db-password:
      env: SONAR_JDBC_PASSWORD
      type: string
      value: <- `${database-password}`
    db-name:
      type: string
      value: <- `${database-name}`
    db-host:
      type: string
      value: <- connection-hostname("postgres")
    SONARQUBE_IMAGE:
      type: string
      value: <- `${sonarqube-image-tag}`
